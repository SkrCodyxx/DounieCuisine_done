#!/bin/bash
# SCRIPT DE D√âPLOIEMENT COMPLET AVEC SYST√àME DE D√âPENDANCES
# DOUNIE CUISINE - Restaurant Ha√Øtien
# Ordre d'ex√©cution: Base de donn√©es ‚Üí Services Backend ‚Üí Services Frontend

set -e

echo "üöÄ D√âPLOIEMENT COMPLET DOUNIE CUISINE AVEC GESTION DES D√âPENDANCES"

# Variables
PROJECT_DIR="/app"
LOG_DIR="/var/log/dounie"

# Couleurs pour les logs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Fonction de log avec couleurs
log() {
    echo -e "${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[$(date '+%Y-%m-%d %H:%M:%S')] ‚úÖ $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}[$(date '+%Y-%m-%d %H:%M:%S')] ‚ö†Ô∏è $1${NC}"
}

log_error() {
    echo -e "${RED}[$(date '+%Y-%m-%d %H:%M:%S')] ‚ùå $1${NC}"
}

# Fonction pour v√©rifier qu'un service est d√©marr√©
wait_for_service() {
    local service_name=$1
    local port=$2
    local max_attempts=30
    local attempt=1

    log "Attente du d√©marrage de $service_name sur le port $port..."
    
    while [ $attempt -le $max_attempts ]; do
        if curl -s -o /dev/null -w "%{http_code}" http://localhost:$port > /dev/null 2>&1; then
            log_success "$service_name d√©marr√© avec succ√®s (port $port)"
            return 0
        fi
        
        log "Tentative $attempt/$max_attempts pour $service_name..."
        sleep 2
        attempt=$((attempt + 1))
    done
    
    log_error "$service_name n'a pas d√©marr√© dans les temps impartis"
    return 1
}

# Cr√©er les r√©pertoires de logs
sudo mkdir -p $LOG_DIR
sudo chmod 755 $LOG_DIR

echo "üóÇÔ∏è √âTAPE 1: PR√âPARATION DU SYST√àME"

# 1.1 Mise √† jour syst√®me
log "Mise √† jour du syst√®me..."
sudo apt update && sudo apt upgrade -y

# 1.2 Installation des d√©pendances syst√®me
log "Installation des d√©pendances syst√®me..."
sudo apt install -y curl wget git build-essential

echo ""
echo "üì¶ √âTAPE 2: INSTALLATION DES BASES DE DONN√âES (ORDRE DE PRIORIT√â)"

# 2.1 Installation et configuration MongoDB (pour Backend FastAPI)
log "Installation MongoDB..."
if ! command -v mongod &> /dev/null; then
    curl -fsSL https://pgp.mongodb.com/server-7.0.asc | sudo gpg --dearmor -o /usr/share/keyrings/mongodb-server-7.0.gpg
    echo "deb [ signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] http://repo.mongodb.org/apt/debian bookworm/mongodb-org/7.0 main" | sudo tee /etc/apt/sources.list.d/mongodb-org-7.0.list
    sudo apt update
    sudo apt install -y mongodb-org
fi

# 2.2 Installation PostgreSQL (pour API Express)
log "Installation PostgreSQL..."
if ! command -v psql &> /dev/null; then
    sudo apt install -y postgresql postgresql-contrib
fi

# 2.3 D√©marrage des bases de donn√©es (OBLIGATOIRE AVANT LES SERVICES)
log "D√©marrage MongoDB..."
sudo service mongodb start || sudo systemctl start mongod || echo "MongoDB d√©j√† en cours"

log "D√©marrage PostgreSQL..."
sudo service postgresql start || echo "PostgreSQL d√©j√† en cours"

# 2.4 Configuration des bases de donn√©es
log "Configuration des bases de donn√©es..."
sudo -u postgres createdb dounie_cuisine 2>/dev/null || echo "DB dounie_cuisine existe d√©j√†"

log_success "Bases de donn√©es configur√©es et d√©marr√©es"

echo ""
echo "üêç √âTAPE 3: ENVIRONNEMENT PYTHON (Backend FastAPI)"

# 3.1 Installation Python et pip
log "Installation Python et pip..."
sudo apt install -y python3 python3-pip python3-venv

# 3.2 Installation des d√©pendances Backend FastAPI
log "Installation d√©pendances Backend FastAPI..."
cd $PROJECT_DIR/backend
pip3 install -r requirements.txt

log_success "Backend FastAPI configur√©"

echo ""
echo "üü¢ √âTAPE 4: ENVIRONNEMENT NODE.JS (Frontends et API)"

# 4.1 Installation Node.js et npm
log "Installation Node.js..."
if ! command -v node &> /dev/null; then
    curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
    sudo apt install -y nodejs
fi

# 4.2 Installation Yarn
log "Installation Yarn..."
if ! command -v yarn &> /dev/null; then
    npm install -g yarn
fi

# 4.3 Installation serve (pour servir les builds)
log "Installation serve..."
npm install -g serve

echo ""
echo "üì± √âTAPE 5: INSTALLATION D√âPENDANCES APPLICATIONS (ORDRE S√âQUENTIEL)"

# 5.1 API Express (TypeScript)
log "Installation d√©pendances API Express..."
cd $PROJECT_DIR/api
npm install

# 5.2 Frontend React principal
log "Installation d√©pendances Frontend React..."
cd $PROJECT_DIR/frontend
yarn install

# 5.3 Site Public (Vite)
log "Installation d√©pendances Site Public..."
cd $PROJECT_DIR/public
npm install

# 5.4 Administration (avec correction des conflits)
log "Installation d√©pendances Administration..."
cd $PROJECT_DIR/administration
npm install --legacy-peer-deps || npm install --force

log_success "Toutes les d√©pendances install√©es"

echo ""
echo "üî® √âTAPE 6: CONSTRUCTION DES APPLICATIONS (ORDRE DE D√âPENDANCE)"

# 6.1 Build API Express
log "Construction API Express..."
cd $PROJECT_DIR/api
npm run build

# 6.2 Build Site Public
log "Construction Site Public..."
cd $PROJECT_DIR/public
npm run build

# 6.3 Build Administration (si possible)
log "Construction Administration..."
cd $PROJECT_DIR/administration
npm run build || log_warning "Build Administration √©chou√©, utilisation en mode dev"

log_success "Applications construites"

echo ""
echo "‚öôÔ∏è √âTAPE 7: CONFIGURATION SUPERVISOR (GESTION D√âPENDANCES SERVICES)"

log "Configuration Supervisor..."
sudo apt install -y supervisor

# Configuration avec d√©pendances entre services
sudo tee /etc/supervisor/conf.d/dounie-complete.conf > /dev/null <<EOF
[group:dounie-databases]
programs=dounie-mongodb,dounie-postgres

[group:dounie-backends]
programs=dounie-backend-fastapi,dounie-api-express

[group:dounie-frontends]
programs=dounie-frontend-react,dounie-public-site,dounie-admin

; ============= BASES DE DONN√âES (PRIORIT√â 1) =============
[program:dounie-mongodb]
command=mongod --dbpath /var/lib/mongodb --logpath $LOG_DIR/mongodb.log --fork
directory=/var/lib/mongodb
user=mongodb
autostart=true
autorestart=true
priority=100
stderr_logfile=$LOG_DIR/mongodb.err.log
stdout_logfile=$LOG_DIR/mongodb.out.log

[program:dounie-postgres]
command=/usr/lib/postgresql/15/bin/postgres -D /var/lib/postgresql/15/main -c config_file=/etc/postgresql/15/main/postgresql.conf
directory=/var/lib/postgresql/15/main
user=postgres
autostart=true
autorestart=true
priority=101
stderr_logfile=$LOG_DIR/postgres.err.log
stdout_logfile=$LOG_DIR/postgres.out.log

; ============= BACKENDS (PRIORIT√â 2) =============
[program:dounie-backend-fastapi]
command=python3 server.py
directory=$PROJECT_DIR/backend
user=root
autostart=true
autorestart=true
priority=200
stderr_logfile=$LOG_DIR/backend-fastapi.err.log
stdout_logfile=$LOG_DIR/backend-fastapi.out.log
environment=PORT=8001,MONGO_URL="mongodb://localhost:27017/dounie_cuisine"

[program:dounie-api-express]
command=npm start
directory=$PROJECT_DIR/api
user=root
autostart=true
autorestart=true
priority=201
stderr_logfile=$LOG_DIR/api-express.err.log
stdout_logfile=$LOG_DIR/api-express.out.log
environment=NODE_ENV=production,PORT=5000

; ============= FRONTENDS (PRIORIT√â 3) =============
[program:dounie-frontend-react]
command=yarn start
directory=$PROJECT_DIR/frontend
user=root
autostart=true
autorestart=true
priority=300
stderr_logfile=$LOG_DIR/frontend-react.err.log
stdout_logfile=$LOG_DIR/frontend-react.out.log
environment=PORT=3000

[program:dounie-public-site]
command=npm run preview -- --port 80 --host 0.0.0.0
directory=$PROJECT_DIR/public
user=root
autostart=true
autorestart=true
priority=301
stderr_logfile=$LOG_DIR/public-site.err.log
stdout_logfile=$LOG_DIR/public-site.out.log

[program:dounie-admin]
command=serve -s build -l 3001
directory=$PROJECT_DIR/administration
user=root
autostart=true
autorestart=true
priority=302
stderr_logfile=$LOG_DIR/admin.err.log
stdout_logfile=$LOG_DIR/admin.out.log
EOF

echo ""
echo "üöÄ √âTAPE 8: D√âMARRAGE S√âQUENTIEL DES SERVICES (ORDRE DE D√âPENDANCE)"

# 8.1 Red√©marrage supervisor
log "Red√©marrage de Supervisor..."
sudo service supervisor restart
sudo supervisorctl reread
sudo supervisorctl update

# 8.2 D√©marrage en ordre de priorit√©
log "D√©marrage des bases de donn√©es (Priorit√© 1)..."
sudo supervisorctl start dounie-databases:*
sleep 10

log "D√©marrage des backends (Priorit√© 2)..."
sudo supervisorctl start dounie-backends:*
sleep 15

# V√©rification des backends avant de d√©marrer les frontends
if wait_for_service "Backend FastAPI" 8001; then
    log_success "Backend FastAPI pr√™t"
else
    log_warning "Backend FastAPI n'est pas pr√™t, mais on continue"
fi

log "D√©marrage des frontends (Priorit√© 3)..."
sudo supervisorctl start dounie-frontends:*

echo ""
echo "üîç √âTAPE 9: V√âRIFICATION DES SERVICES (TESTS DE SANT√â)"

sleep 20

# Tests de sant√© pour chaque service
log "V√©rification de l'√©tat des services..."

# Backend FastAPI (Port 8001)
if curl -f http://localhost:8001/api/health > /dev/null 2>&1; then
    log_success "‚úÖ Backend FastAPI (Port 8001) - OP√âRATIONNEL"
else
    log_error "‚ùå Backend FastAPI (Port 8001) - NON ACCESSIBLE"
fi

# API Express (Port 5000)
if curl -f http://localhost:5000/api/health > /dev/null 2>&1; then
    log_success "‚úÖ API Express (Port 5000) - OP√âRATIONNEL"
else
    log_warning "‚ö†Ô∏è API Express (Port 5000) - NON ACCESSIBLE"
fi

# Frontend React (Port 3000)
if curl -f http://localhost:3000 > /dev/null 2>&1; then
    log_success "‚úÖ Frontend React (Port 3000) - OP√âRATIONNEL"
else
    log_error "‚ùå Frontend React (Port 3000) - NON ACCESSIBLE"
fi

# Site Public (Port 80)
if curl -f http://localhost:80 > /dev/null 2>&1; then
    log_success "‚úÖ Site Public (Port 80) - OP√âRATIONNEL"
else
    log_error "‚ùå Site Public (Port 80) - NON ACCESSIBLE"
fi

# Administration (Port 3001)
if curl -f http://localhost:3001 > /dev/null 2>&1; then
    log_success "‚úÖ Administration (Port 3001) - OP√âRATIONNEL"
else
    log_warning "‚ö†Ô∏è Administration (Port 3001) - NON ACCESSIBLE"
fi

echo ""
echo "üéâ D√âPLOIEMENT COMPLET TERMIN√â!"

echo ""
echo "=== INFORMATIONS D'ACC√àS ==="
echo "üåê Site Public (Vite): http://localhost:80"
echo "üë• Frontend React: http://localhost:3000"
echo "üîß Administration: http://localhost:3001"
echo "üîå API Express: http://localhost:5000"
echo "üîå Backend FastAPI: http://localhost:8001"
echo "üìä MongoDB: localhost:27017"
echo "üêò PostgreSQL: localhost:5432"

echo ""
echo "=== GESTION DES SERVICES (ORDRE DE D√âPENDANCE) ==="
echo "Status global: sudo supervisorctl status"
echo "Restart bases: sudo supervisorctl restart dounie-databases:*"
echo "Restart backends: sudo supervisorctl restart dounie-backends:*"
echo "Restart frontends: sudo supervisorctl restart dounie-frontends:*"
echo "Logs syst√®me: tail -f $LOG_DIR/*.log"
echo "================================="